<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>ระบบสุริยะ (Optimized WebXR)</title>

  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

  <style>
    /* === Global Styles === */
    body { 
      margin: 0; 
      font-family: 'Kanit', 'Segoe UI', Tahoma, sans-serif;
      overflow: hidden;
      background-color: #000;
      /* สำคัญ: ป้องกัน Browser ขยับหรือซูมหน้าเว็บเอง เพื่อให้ Pinch Zoom ใน 3D ทำงานได้ */
      touch-action: none; 
    }
    
    .a-enter-vr-button { display: none !important; }

    /* === UI Overlay === */
    #ui-layer {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; 
      z-index: 100;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    #ui-layer > * { pointer-events: auto; }

    /* === Info Panel === */
    #infoPanel {
      position: absolute;
      top: 20px; left: 20px; right: 20px;
      max-width: 320px;
      margin: 0 auto;
      background: rgba(20, 20, 35, 0.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 20px;
      color: white;
      transform: translateY(-20px);
      opacity: 0;
      transition: all 0.3s ease;
      display: none;
    }

    #infoPanel.active {
      display: block;
      transform: translateY(0);
      opacity: 1;
    }

    #infoPanel h3 {
      margin: 0 0 8px 0;
      font-size: 1.2rem;
      color: #bb86fc;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding-bottom: 8px;
    }

    #infoPanel p {
      margin: 0 0 16px 0;
      font-size: 0.95rem;
      line-height: 1.5;
      color: #e0e0e0;
    }

    #closeInfo {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      width: 100%;
      cursor: pointer;
      font-weight: 600;
    }

    /* === Bottom Controls === */
    .bottom-controls {
      position: absolute;
      bottom: 20px; left: 0; width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding-bottom: env(safe-area-inset-bottom);
    }

    #controlPanel {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      padding: 8px 16px;
      border-radius: 24px;
      display: flex;
      gap: 10px;
    }

    .icon-btn {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .icon-btn.active { background: #6200ee; }

    #arButton {
      background: linear-gradient(135deg, #ff0080, #7928ca);
      color: white;
      border: none;
      padding: 14px 40px;
      border-radius: 30px;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 4px 20px rgba(255, 0, 128, 0.4);
      margin-bottom: 5px;
    }

    .mini-status {
      display: flex; align-items: center; gap: 10px;
      background: rgba(0,0,0,0.5);
      padding: 4px 12px; border-radius: 20px;
      color: rgba(255,255,255,0.8); font-size: 12px;
    }
    input[type=range] { accent-color: #bb86fc; height: 4px; width: 80px; }
  </style>

  <script>
    // === Component: Zoom Manager (แก้ไขให้รองรับ Window Events) ===
    AFRAME.registerComponent('ar-scale-manager', {
      schema: { min: {default: 0.05}, max: {default: 10} },
      init: function() {
        this.wrapper = document.getElementById('solar-system-wrapper');
        this.initialDist = 0;
        this.initialScale = 1;
        this.isPinching = false;

        // ใช้ Window แทน Canvas เพื่อจับ event ได้แน่นอนกว่า
        window.addEventListener('touchstart', (e) => {
          if (e.touches.length === 2) {
            this.isPinching = true;
            this.initialDist = Math.hypot(
              e.touches[0].pageX - e.touches[1].pageX,
              e.touches[0].pageY - e.touches[1].pageY
            );
            this.initialScale = this.wrapper.object3D.scale.x;
          }
        }, {passive: false});

        window.addEventListener('touchmove', (e) => {
          if (this.isPinching && e.touches.length === 2) {
            e.preventDefault(); // ป้องกันการซูมหน้าเว็บปกติ
            const currentDist = Math.hypot(
              e.touches[0].pageX - e.touches[1].pageX,
              e.touches[0].pageY - e.touches[1].pageY
            );
            
            // เพิ่มความไวในการซูมเล็กน้อย
            const factor = currentDist / this.initialDist;
            let newScale = this.initialScale * factor;
            
            newScale = Math.min(Math.max(newScale, this.data.min), this.data.max);
            this.wrapper.setAttribute('scale', `${newScale} ${newScale} ${newScale}`);
          }
        }, {passive: false});

        window.addEventListener('touchend', () => {
          this.isPinching = false;
        });
      }
    });

    // === Component: AR Controller ===
    AFRAME.registerComponent('ar-controller', {
      init: function () {
        const sceneEl = this.el;
        const sky = document.getElementById('sky');
        const stars = document.getElementById('stars');
        const arBtn = document.getElementById('arButton');
        const wrapper = document.getElementById('solar-system-wrapper');

        sceneEl.addEventListener('enter-vr', () => {
          if (sceneEl.is('ar-mode')) {
            if(sky) sky.setAttribute('visible', false);
            if(stars) stars.setAttribute('visible', false);
            if(arBtn) arBtn.style.display = 'none';
            
            // ปรับตำแหน่งเริ่มต้นใน AR ให้เห็นชัดขึ้น
            wrapper.setAttribute('position', '0 -0.5 -2'); 
            wrapper.setAttribute('scale', '0.2 0.2 0.2');
          }
        });

        sceneEl.addEventListener('exit-vr', () => {
          if(sky) sky.setAttribute('visible', true);
          if(stars) stars.setAttribute('visible', true);
          if(arBtn) arBtn.style.display = 'block';
          
          wrapper.setAttribute('position', '0 0 0');
          wrapper.setAttribute('scale', '1 1 1');
        });
      }
    });
  </script>
</head>

<body>

  <div id="ui-layer">
    <div id="infoPanel">
      <h3 id="infoTitle">ชื่อดาว</h3>
      <p id="infoText">รายละเอียด...</p>
      <button id="closeInfo">ปิดหน้าต่าง</button>
    </div>

    <div class="bottom-controls">
      <div class="mini-status">
        <span>ความเร็ว: <span id="speedValue">1.0x</span></span>
        <input type="range" id="speedSlider" min="0" max="5" step="0.5" value="1">
      </div>

      <div id="controlPanel">
        <button id="toggleOrbits" class="icon-btn active">วงโคจร</button>
        <button id="toggleLabels" class="icon-btn active">ชื่อดาว</button>
      </div>

      <button id="arButton">✨ เข้าสู่โหมด AR</button>
    </div>
  </div>

  <a-scene
    vr-mode-ui="enabled: false"
    ar-controller
    ar-scale-manager
    cursor="rayOrigin: mouse; fuse: false" 
    raycaster="objects: .clickable"
    renderer="colorManagement: true; antialias: true; alpha: true; precision: medium"
    webxr="optionalFeatures: dom-overlay; overlayElement: #ui-layer">

    <a-assets>
       <img id="skyTexture" src="textures/stars.jpg">
    </a-assets>

    <a-sky id="sky" src="#skyTexture"></a-sky>
    
    <a-entity id="stars"></a-entity>

    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: point; intensity: 1.5; distance: 50; decay: 2" position="0 0 0"></a-entity>

    <a-entity id="cameraRig" position="0 1.6 8">
      <a-entity camera look-controls wasd-controls></a-entity>
    </a-entity>

    <a-entity id="solar-system-wrapper">
      
      <a-entity id="sun-parent" position="0 0 0">
        <a-sphere id="sun" radius="1.2" src="textures/sun.jpg" color="#FDB813"
                segments-width="32" segments-height="32"
                material="shader: flat; emissive: #FDB813; emissiveIntensity: 0.6"></a-sphere>
        <a-sphere radius="1.4" color="#FDB813" opacity="0.3" transparent="true" segments-width="16" segments-height="16" material="side: back"></a-sphere>
      </a-entity>

      <a-entity id="orbit-mercury" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="1.59" radius-outer="1.60" color="#ffffff" opacity="0.2" segments-theta="32"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:8000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="1.6 0 0">
            <a-sphere class="clickable" radius="0.3" visible="false"></a-sphere> 
            <a-sphere class="planet-mesh" radius="0.08" src="textures/mercury.jpg" color="#A5A5A5"
                      segments-width="16" segments-height="16"
                      data-name="Mercury (ดาวพุธ)"
                      data-info="ดาวเคราะห์จิ๋วใกล้ดวงอาทิตย์ที่สุด ร้อนจัดในตอนกลางวันและหนาวจัดในตอนกลางคืน">
            </a-sphere>
            <a-text class="planet-label" value="Mercury" align="center" position="0 0.25 0" scale="0.5 0.5 0.5" side="double"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="orbit-venus" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="2.29" radius-outer="2.30" color="#ffffff" opacity="0.2" segments-theta="32"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:12000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="2.3 0 0">
            <a-sphere class="clickable" radius="0.4" visible="false"></a-sphere>
            <a-sphere class="planet-mesh" radius="0.14" src="textures/venus.jpg" color="#E3BB76"
                      segments-width="32" segments-height="32"
                      data-name="Venus (ดาวศุกร์)"
                      data-info="ฝาแฝดของโลกที่ร้อนระอุ ปกคลุมด้วยเมฆหนาทึบและแก๊สเรือนกระจก">
            </a-sphere>
            <a-text class="planet-label" value="Venus" align="center" position="0 0.35 0" scale="0.6 0.6 0.6" side="double"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="orbit-earth" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="3.19" radius-outer="3.20" color="#ffffff" opacity="0.2" segments-theta="32"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:18000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="3.2 0 0">
            <a-sphere class="clickable" radius="0.5" visible="false"></a-sphere>
            <a-sphere class="planet-mesh" radius="0.18" src="textures/earth.jpg" color="#4B9CD3"
                      segments-width="32" segments-height="32"
                      data-name="Earth (โลก)"
                      data-info="บ้านของเรา ดาวเคราะห์เพียงดวงเดียวที่เรารู้ว่ามีสิ่งมีชีวิตอาศัยอยู่ได้">
            </a-sphere>
            <a-text class="planet-label" value="Earth" align="center" position="0 0.45 0" scale="0.6 0.6 0.6" side="double"></a-text>
            <a-entity animation="property:rotation; to:0 360 0; dur:3000; loop:true; easing:linear">
               <a-sphere radius="0.05" position="0.3 0 0" src="textures/moon.jpg" color="#ddd" segments-width="8" segments-height="8"></a-sphere>
            </a-entity>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="orbit-mars" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="4.09" radius-outer="4.10" color="#ffffff" opacity="0.2" segments-theta="32"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:24000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="4.1 0 0">
            <a-sphere class="clickable" radius="0.4" visible="false"></a-sphere>
            <a-sphere class="planet-mesh" radius="0.12" src="textures/mars.jpg" color="#E27B58"
                      segments-width="16" segments-height="16"
                      data-name="Mars (ดาวอังคาร)"
                      data-info="ดาวแดงที่มีพายุฝุ่นปกคลุม และเป็นเป้าหมายต่อไปในการสำรวจของมนุษย์">
            </a-sphere>
            <a-text class="planet-label" value="Mars" align="center" position="0 0.35 0" scale="0.6 0.6 0.6" side="double"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="orbit-jupiter" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="5.99" radius-outer="6.00" color="#ffffff" opacity="0.2" segments-theta="64"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:38000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="6.0 0 0">
            <a-sphere class="clickable" radius="0.8" visible="false"></a-sphere>
            <a-sphere class="planet-mesh" radius="0.5" src="textures/jupiter.jpg" color="#C88B3A"
                      segments-width="32" segments-height="32"
                      data-name="Jupiter (ดาวพฤหัส)"
                      data-info="พี่ใหญ่แห่งระบบสุริยะ เป็นดาวแก๊สยักษ์ที่มีพายุหมุนแดงใหญ่ (Great Red Spot)">
            </a-sphere>
            <a-text class="planet-label" value="Jupiter" align="center" position="0 0.9 0" scale="1 1 1" side="double"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="orbit-saturn" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="7.99" radius-outer="8.00" color="#ffffff" opacity="0.2" segments-theta="64"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:48000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="8.0 0 0">
            <a-sphere class="clickable" radius="0.8" visible="false"></a-sphere>
            <a-sphere class="planet-mesh" radius="0.45" src="textures/saturn.jpg" color="#C5AB6E"
                      segments-width="32" segments-height="32"
                      data-name="Saturn (ดาวเสาร์)"
                      data-info="ราชินีแห่งวงแหวน มีวงแหวนน้ำแข็งที่สวยงามและชัดเจนที่สุด">
            </a-sphere>
            <a-ring rotation="90 0 0" radius-inner="0.6" radius-outer="1.0" color="#C5AB6E" opacity="0.8" side="double" segments-theta="32"></a-ring>
            <a-text class="planet-label" value="Saturn" align="center" position="0 0.8 0" scale="0.9 0.9 0.9" side="double"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="orbit-uranus" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="9.49" radius-outer="9.50" color="#ffffff" opacity="0.2" segments-theta="64"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:58000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="9.5 0 0">
            <a-sphere class="clickable" radius="0.6" visible="false"></a-sphere>
            <a-sphere class="planet-mesh" radius="0.3" src="textures/uranus.jpg" color="#4FD0E7"
                      segments-width="32" segments-height="32"
                      data-name="Uranus (ดาวยูเรนัส)"
                      data-info="ดาวมฤตยูที่หมุนตะแคงข้าง มีบรรยากาศสีฟ้าอมเขียวจากแก๊สมีเทน">
            </a-sphere>
            <a-text class="planet-label" value="Uranus" align="center" position="0 0.6 0" scale="0.8 0.8 0.8" side="double"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="orbit-neptune" class="orbit-ring">
        <a-ring rotation="-90 0 0" radius-inner="10.99" radius-outer="11.00" color="#ffffff" opacity="0.2" segments-theta="64"></a-ring>
        <a-entity animation="property:rotation; to:0 360 0; dur:68000; loop:true; easing:linear" class="planet-orbit">
          <a-entity position="11.0 0 0">
            <a-sphere class="clickable" radius="0.6" visible="false"></a-sphere>
            <a-sphere class="planet-mesh" radius="0.3" src="textures/neptune.jpg" color="#29559B"
                      segments-width="32" segments-height="32"
                      data-name="Neptune (ดาวเนปจูน)"
                      data-info="ดาวเกตุที่อยู่ไกลสุด มีลมพายุรุนแรงที่สุดในระบบสุริยะ สีน้ำเงินเข้ม">
            </a-sphere>
            <a-text class="planet-label" value="Neptune" align="center" position="0 0.6 0" scale="0.8 0.8 0.8" side="double"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>
    </a-entity> 
  </a-scene>

  <script>
    // === Logic Interaction ===

    document.getElementById('arButton').addEventListener('click', function() {
      const scene = document.querySelector('a-scene');
      scene.enterAR();
    });

    // Info Panel Logic
    const infoPanel = document.getElementById('infoPanel');
    const infoTitle = document.getElementById('infoTitle');
    const infoText = document.getElementById('infoText');

    // ใช้ Event Delegation หรือผูกกับ Class Clickable โดยตรง
    // หมายเหตุ: เราเปลี่ยนให้ตัวรับคลิก (clickable) เป็น Hitbox ใสๆ รอบดาว
    // ดังนั้นเราต้องดึงข้อมูลจากตัวดาวจริง (planet-mesh) ที่อยู่ข้างๆ กัน
    document.querySelectorAll('.clickable').forEach(el => {
      el.addEventListener('click', function(evt) {
        // หาตัว Mesh ที่เก็บข้อมูล (พี่น้องของ Hitbox)
        const planetMesh = this.parentElement.querySelector('.planet-mesh');
        if (!planetMesh) return;

        infoTitle.innerText = planetMesh.getAttribute('data-name');
        infoText.innerText = planetMesh.getAttribute('data-info');
        
        infoPanel.style.display = 'block';
        requestAnimationFrame(() => infoPanel.classList.add('active'));
        
        // Animation เด้งดึ๋ง
        const originalScale = planetMesh.object3D.scale.clone();
        planetMesh.object3D.scale.multiplyScalar(1.3);
        setTimeout(() => {
          planetMesh.object3D.scale.copy(originalScale);
        }, 200);
      });
    });

    document.getElementById('closeInfo').addEventListener('click', () => {
      infoPanel.classList.remove('active');
      setTimeout(() => { infoPanel.style.display = 'none'; }, 300);
    });

    // Toggle Orbits
    let orbitsVisible = true;
    document.getElementById('toggleOrbits').onclick = function() {
      orbitsVisible = !orbitsVisible;
      document.querySelectorAll('.orbit-ring').forEach(ring => {
        ring.setAttribute('visible', orbitsVisible);
      });
      this.classList.toggle('active');
    };

    // Toggle Labels
    let labelsVisible = true;
    document.getElementById('toggleLabels').onclick = function() {
      labelsVisible = !labelsVisible;
      document.querySelectorAll('.planet-label').forEach(label => {
        label.setAttribute('visible', labelsVisible);
      });
      this.classList.toggle('active');
    };

    // Speed Slider
    const speedSlider = document.getElementById('speedSlider');
    const speedValue = document.getElementById('speedValue');
    
    speedSlider.addEventListener('input', (e) => {
      const speed = parseFloat(e.target.value);
      speedValue.innerText = speed + "x";
      
      document.querySelectorAll('.planet-orbit').forEach(orbit => {
        if (!orbit.getAttribute('data-original-dur')) {
          const anim = orbit.getAttribute('animation');
          if(anim) orbit.setAttribute('data-original-dur', anim.dur);
        }
        const originalDur = parseInt(orbit.getAttribute('data-original-dur'));
        
        if (speed === 0) {
          orbit.removeAttribute('animation');
        } else {
          const newDur = originalDur / speed;
          // ใช้ easing linear เพื่อให้หมุนต่อเนื่องไม่กระตุกเวลาเปลี่ยนความเร็ว
          orbit.setAttribute('animation', `property:rotation; to:0 360 0; dur:${newDur}; loop:true; easing:linear`);
        }
      });
    });

    // Generate Stars Optimized (ลดจำนวนลง และเอา Animation ออก)
    const starsEl = document.getElementById('stars');
    // ลดจำนวนจาก 500 เหลือ 150 เพื่อประสิทธิภาพบนมือถือ
    const starCount = 150; 
    
    for (let i = 0; i < starCount; i++) {
      const star = document.createElement('a-entity'); // ใช้ Entity ว่างเปล่า + Geometry/Material แบบ Basic
      const x = (Math.random() - 0.5) * 150;
      const y = (Math.random() - 0.5) * 150;
      const z = (Math.random() - 0.5) * 150;
      
      star.setAttribute('position', `${x} ${y} ${z}`);
      
      // ใช้ Primitive ง่ายๆ หรือ Plane เล็กๆ แทน Sphere
      star.setAttribute('geometry', 'primitive: plane; width: 0.15; height: 0.15');
      star.setAttribute('material', 'shader: flat; color: #FFF; opacity: 0.8');
      
      // Billboarding (ให้หันหาคนตลอด)
      star.setAttribute('look-at', '[camera]');

      // เอา Animation กระพริบออก เพราะทำให้ FPS ตกเวลาเรนเดอร์เยอะๆ
      
      starsEl.appendChild(star);
    }
  </script>
</body>
</html>